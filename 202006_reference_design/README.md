Design simulation tool: reference design
========================================

Release:

* 9 July 2020, `s4_design_sim_tool` 1.0.3

This is a set of maps generated by the CMB-S4 design simulation tool, available at <https://github.com/CMB-S4/s4_design_sim_tool>

It is a map-based tool which combines and weights pre-generated maps generated via short time domain simulations (~10 days) and weights them based on the CMB-S4 design (e.g. number of tubes per telescope per site).

The documentation about the bandpass-integrated and beam smoothed full sky foreground and CMB maps used as inputs are available at <https://github.com/CMB-S4/s4mapbasedsims/tree/master/202006_foregrounds_extragalactic_cmb_tophat>.


This release includes noise, atmosphere, foreground and CMB maps for the CMB-S4 reference design.

Documentation about the input maps and the transfer function applied by the tool is available
in the documentation of the design simulation tool available at: <https://cmb-s4.github.io/s4_design_sim_tool/>.

# Instrument model

We are using the reference design configuration with a few fixes to the noise levels,
all the numbers have been exported on 7th July 2020 from `s4sim` [commit c2732f0e8fb01](https://github.com/CMB-S4/s4sim/pull/8/commits/c2732f0e8fb014392cef664ff4213bf47133aaac) and the instrument spreadsheet (just for the number of detectors).

The `telescopes` section of the simulations configuration files describes the distribution of telescopes and tubes,
see [on the repository](https://github.com/CMB-S4/s4mapbasedsims/blob/753307546ecb3145369609d0162131d51efbbb9a/202006_reference_design/s4_reference_design_noise_atmo_7splits.toml#L32-L61).
Parameters like beams and bandpasses are available in the `cmbs4_tophat.h5` file in this repository, and [exported to CSV for convenience](https://github.com/CMB-S4/s4mapbasedsims/blob/master/202006_foregrounds_extragalactic_cmb_tophat/cmbs4_tophat.csv).

# Verification

## Plots of the maps

* [Plots of all full experiment maps on the same scale](plot_maps/README.md)

## Noise + Atmosphere

* [`C_ell` computation script](compute_cl.py), [Plotting notebook](validation_atmo_noise.ipynb)
* [Plots of spectra of noise + atmosphere, LAT pole](plots/LAT_pole.md)
* [Plots of spectra of noise + atmosphere, LAT chile](plots/LAT_chile.md)
* [Plots of spectra of noise + atmosphere, SAT](plots/SAT.md)
* [Plots of hitmaps, LAT pole](plots/hitmap_LAT_pole.md)
* [Plots of hitmaps, LAT chile](plots/hitmap_LAT_chile.md)
* [Plots of hitmaps, SAT](plots/hitmap_SAT.md)
* [Plots of spectra of noise + atmosphere, 7-way splits, SAT](plots/SAT_7.md)

## Foregrounds and CMB

Plots are interactive, first click on the "Click here to toggle on/off the raw code" buttone, then click on the legend to select channel, double-click on plot to reset, zoom with scrolling.

For foregrounds, I compare the output total foregrounds both to the input synchrotron and the input dust, just
to check they are reasonable.

* [TT](https://nbviewer.jupyter.org/gist/zonca/29706d266015f21db8a6f217e3508f19)
* [EE](https://nbviewer.jupyter.org/gist/zonca/37b99d0446d338191b4f660992c0c661)
* [BB](https://nbviewer.jupyter.org/gist/zonca/c75ce0a8b372dc98fbba50c6f611cea8)


# Available maps

* `N_side` 512 for SAT, 4096 for LAT
* float32 precision
* `K_CMB` unit
* One map per band per site which combines all the telescopes at that band, atmosphere scales down as telescope-years, noise as detector-years

Metadata are available in the fits headers of extension 1, for example:

```
SOFTWARE= 's4_design_sim_tool'                                                  
SW_VERS = '1.0.1   '                                                            
SKY_VERS= '1.0     '                                                            
ATM_VERS= '1.0     '                                                            
NOI_VERS= '1.0     '                                                            
SITE    = 'Pole    '                                                            
SPLIT   =                    2                                                  
NSPLITS =                    7                                                  
CHANNEL = 'HFL1    '                                                            
DATE    = '2020-04-23'                                                          
CONFMD5 = '79858f71dbaf1c8bd9bd57a2cbea57ed'   
```

## Noise and atmosphere

1 full map based on 7 years of mission and 7 independent splits with equal sky coverage.

The configuration file for the design simulation tool is:

* [`s4_reference_design_noise_atmo_7splits.toml`](s4_reference_design_noise_atmo_7splits.toml)

Maps are available at NERSC at:

    /global/project/projectdirs/cmbs4/dm/dstool/output/s4_reference_design_noise_atmo_7splits

Will be moved to project space later on and the path here updated

File naming convention:

    "{telescope}-{band}_{site}/cmbs4_KCMB_{telescope}-{band}_{site}_nside{nside}_{split}_of_{nsplits}.fits"

Where:
   
* `telescope` LAT or SAT
* `band` e.g. LFL2
* `site` pole or chile
* `split` and `nsplits` the current split (starts from 1) and the number of splits, so `1_of_1` is a full mission map, `3 of 7` is the 3rd year of observation on 7 yearly splits.

For example:

    LAT-LFL2_chile/cmbs4_KCMB_LAT-LFL2_chile_nside4096_1_of_1.fits
    LAT-LFL2_chile/cmbs4_KCMB_LAT-LFL2_chile_nside4096_3_of_7.fits

This dataset also includes hitmaps and white noise covariance matrices properly scaled for full mission and the splits,
for example:

    LAT-HFL1_pole/cmbs4_hitmap_LAT-HFL1_pole_nside4096_1_of_1.fits
    LAT-HFL1_pole/cmbs4_hitmap_LAT-HFL1_pole_nside4096_1_of_7.fits
    LAT-HFL1_pole/cmbs4_wcov_LAT-HFL1_pole_nside4096_1_of_1.fits
    LAT-HFL1_pole/cmbs4_wcov_LAT-HFL1_pole_nside4096_1_of_7.fits

The noise and atmosphere maps from TOAST used as input are currently located at:

    /global/project/projectdirs/cmbs4/dm/dstool/input

## CMB and foregrounds

CMB and foreground maps are generated applying the mapmaking step in map domain to the [full sky, bandpass-integrated and beam-convolved input map based simulations](https://github.com/CMB-S4/s4mapbasedsims/tree/master/202006_foregrounds_extragalactic_cmb_tophat#input-components).
See their documentation for details about all the models used.
We have just 1 split, i.e. there is no weighting done for CMB and foregrounds.

We have 1 map per tube for each of 3 components (with link to TOML configuration file):

* [foregrounds (dust, free-free, synchrotron, ame, Websky CIB/tsz/ksz)](s4_reference_design_foregrounds.toml)
* [CMB scalar (Websky compatible cosmology, scalar modes and lensing with Websky potential)](s4_reference_design_cmb_r0.toml)
* [CMB tensor only (`r=3e-3`)](s4_reference_design_cmb_tensor_only_r3e-3.toml)

Maps are available at NERSC at:

    /global/project/projectdirs/cmbs4/dm/dstool/output

in the 3 subfolders:

* `s4_reference_design_foregrounds`
* `s4_reference_design_cmb_r0`
* `s4_reference_design_cmb_tensor_only_r3e-3`

File naming convention:

    "{telescope}-{band}_{site}/cmbs4_KCMB_{telescope}-{band}_{site}_nside{nside}_{split}_of_{nsplits}.fits"

Where:
   
* `telescope` LAT or SAT
* `band` e.g. LFL2
* `site` pole or chile
* `split` and `nsplits` the current split and the number of splits, so `1_of_1` is a full mission map

For example:

    s4_reference_design_foregrounds/LAT-LFL2_chile/cmbs4_KCMB_LAT-LFL2_chile_nside4096_1_of_1.fits

The foreground and CMB maps used as input are currently located at:

    /global/project/projectdirs/cmbs4/dm/dstool/input
