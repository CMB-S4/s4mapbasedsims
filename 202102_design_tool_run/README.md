Design tool run March 2021
==========================

Documentation progress, parts updated (the rest has only been copied from prev release):

* Instrument model


Release:


This is a set of maps generated by the CMB-S4 design simulation tool, available at <https://github.com/CMB-S4/s4_design_sim_tool>

It is a map-based tool which combines and weights pre-generated maps generated via short time domain simulations (~10 days) and weights them based on the CMB-S4 design (e.g. number of tubes per telescope per site).

The documentation about the bandpass-integrated and beam smoothed full sky foreground and CMB maps used as inputs are available at <https://github.com/CMB-S4/s4mapbasedsims/tree/master/202102_design_tool_input>.


This release includes noise, atmosphere, foreground and CMB maps.


# Instrument model

The instrument model has been extracted from `s4sim` on February, the 10th, 2021, using the Git hash: `ca07638f6781144648938a636a972711321ba166`,
see the [notebook script for more details](utils/create_s4_instrument_parameters.ipynb), the instrument parameters have been extracted to
[text files in IPAC table format](instrument_model/cmbs4_instrument_model.tbl), which supports units for the columns and can be read as `astropy.QTable`.

```python
s4 = QTable.read("instrument_model/cmbs4_instrument_model.tbl", format="ascii.ipac" )
s4.add_index("band")
```

Example on how to access all parameters for a band, or a specific one:

```python
s4.loc["LFS1"]
s4.loc["LFS1"]["fwhm"]
```

# Verification

## Plots of the maps

* [Plots of all full experiment maps on the same scale](plot_maps/README.md)
* [Comparison in gnomview of input and output foregrounds for SAT](plot_gnomview/README.md)

## Noise + Atmosphere

* [`C_ell` computation script](compute_cl.py), [Plotting notebook](validation_atmo_noise.ipynb)
* [Plots of spectra of noise + atmosphere, LAT pole](plots/LAT_pole.md)
* [Plots of spectra of noise + atmosphere, LAT chile](plots/LAT_chile.md)
* [Plots of spectra of noise + atmosphere, SAT pole](plots/SAT.md)
* [Plots of spectra of noise + atmosphere, SAT chile](plots/SAT_chile.md)
* [Plots of hitmaps, LAT pole](plots/hitmap_LAT_pole.md)
* [Plots of hitmaps, LAT chile](plots/hitmap_LAT_chile.md)
* [Plots of hitmaps, SAT pole](plots/hitmap_SAT.md)
* [Plots of hitmaps, SAT chile](plots/hitmap_SAT_chile.md)
* [Plots of spectra of noise + atmosphere, 7-way splits, SAT pole](plots/SAT_7.md)
* [Plots of spectra of noise + atmosphere, 7-way splits, SAT chile](plots/SAT_chile_7.md)

## Foregrounds and CMB

Plots are interactive, first click on the "Click here to toggle on/off the raw code" buttone, then click on the legend to select channel, double-click on plot to reset, zoom with scrolling.

For foregrounds, I compare the output total foregrounds both to the input synchrotron and the input dust, just
to check they are reasonable.

* [TT](https://nbviewer.jupyter.org/gist/zonca/29706d266015f21db8a6f217e3508f19)
* [EE](https://nbviewer.jupyter.org/gist/zonca/37b99d0446d338191b4f660992c0c661)
* [BB](https://nbviewer.jupyter.org/gist/zonca/c75ce0a8b372dc98fbba50c6f611cea8)


# Available maps

* `N_side` 512 for SAT, 4096 for LAT
* float32 precision
* `K_CMB` unit
* One map per band per site which combines all the telescopes at that band, atmosphere scales down as telescope-years, noise as detector-years

Metadata are available in the fits headers of extension 1, for example:

```
SOFTWARE= 's4_design_sim_tool'                                                  
SW_VERS = '1.0.1   '                                                            
SKY_VERS= '1.0     '                                                            
ATM_VERS= '1.0     '                                                            
NOI_VERS= '1.0     '                                                            
SITE    = 'Pole    '                                                            
SPLIT   =                    2                                                  
NSPLITS =                    7                                                  
CHANNEL = 'HFL1    '                                                            
DATE    = '2020-04-23'                                                          
CONFMD5 = '79858f71dbaf1c8bd9bd57a2cbea57ed'   
```

## Noise and atmosphere

1 full map based on 7 years of mission and 7 independent splits with equal sky coverage.

The configuration file for the design simulation tool is:

* [`s4_reference_design_noise_atmo_7splits.toml`](s4_reference_design_noise_atmo_7splits.toml)

Maps are available at NERSC at:

    /global/project/projectdirs/cmbs4/dm/dstool/output/s4_reference_design_noise_atmo_7splits

Will be moved to project space later on and the path here updated

File naming convention:

    "{telescope}-{band}_{site}/cmbs4_KCMB_{telescope}-{band}_{site}_nside{nside}_{split}_of_{nsplits}.fits"

Where:
   
* `telescope` LAT or SAT
* `band` e.g. LFL2
* `site` pole or chile
* `split` and `nsplits` the current split (starts from 1) and the number of splits, so `1_of_1` is a full mission map, `3 of 7` is the 3rd year of observation on 7 yearly splits.

For example:

    LAT-LFL2_chile/cmbs4_KCMB_LAT-LFL2_chile_nside4096_1_of_1.fits
    LAT-LFL2_chile/cmbs4_KCMB_LAT-LFL2_chile_nside4096_3_of_7.fits

This dataset also includes hitmaps and white noise covariance matrices properly scaled for full mission and the splits,
for example:

    LAT-HFL1_pole/cmbs4_hitmap_LAT-HFL1_pole_nside4096_1_of_1.fits
    LAT-HFL1_pole/cmbs4_hitmap_LAT-HFL1_pole_nside4096_1_of_7.fits
    LAT-HFL1_pole/cmbs4_wcov_LAT-HFL1_pole_nside4096_1_of_1.fits
    LAT-HFL1_pole/cmbs4_wcov_LAT-HFL1_pole_nside4096_1_of_7.fits

The white noise matrices also encode pixels discarded during mapmaking and the effect of variable NET with elevation (also on declination for South Pole),
therefore differ at the 5% level with the white noise levels computed naively from the NET and the hitmaps.

The noise and atmosphere maps from TOAST used as input are currently located at:

    /global/project/projectdirs/cmbs4/dm/dstool/input

## CMB and foregrounds

CMB and foreground maps are generated applying the mapmaking step in map domain to the [full sky, bandpass-integrated and beam-convolved input map based simulations](https://github.com/CMB-S4/s4mapbasedsims/tree/master/202006_foregrounds_extragalactic_cmb_tophat#input-components).
See their documentation for details about all the models used.
We have just 1 split, i.e. there is no weighting done for CMB and foregrounds.

We have 1 map per tube for each of 3 components (with link to TOML configuration file):

* [foregrounds (dust, free-free, synchrotron, ame, Websky CIB/tsz/ksz)](s4_reference_design_foregrounds.toml)
* [CMB scalar (Websky compatible cosmology, scalar modes and lensing with Websky potential)](s4_reference_design_cmb_r0.toml)
* [CMB tensor only (`r=3e-3`)](s4_reference_design_cmb_tensor_only_r3e-3.toml)

Maps are available at NERSC at:

    /global/project/projectdirs/cmbs4/dm/dstool/output

in the 3 subfolders:

* `s4_reference_design_foregrounds`
* `s4_reference_design_cmb_r0`
* `s4_reference_design_cmb_tensor_only_r3e-3`

File naming convention:

    "{telescope}-{band}_{site}/cmbs4_KCMB_{telescope}-{band}_{site}_nside{nside}_{split}_of_{nsplits}.fits"

Where:
   
* `telescope` LAT or SAT
* `band` e.g. LFL2
* `site` pole or chile
* `split` and `nsplits` the current split and the number of splits, so `1_of_1` is a full mission map

For example:

    s4_reference_design_foregrounds/LAT-LFL2_chile/cmbs4_KCMB_LAT-LFL2_chile_nside4096_1_of_1.fits

The foreground and CMB maps used as input are currently located at:

    /global/project/projectdirs/cmbs4/dm/dstool/input

## Issues or feedback

In case of any problem with the maps or the documentation or request more/different runs, [open an issue on the `s4mapbasedsims` repo](https://github.com/CMB-S4/s4mapbasedsims/issues)

### Known issues

Due to a bug in the PySM 3 bandpass integration routine, this maps have a overall scale error which is negligible
at the low frequency channels, below 1% at mid-frequencies, and 2-3% at high frequencies, please
see [this issue for the full table of scaling factors](https://github.com/CMB-S4/s4mapbasedsims/issues/5).
